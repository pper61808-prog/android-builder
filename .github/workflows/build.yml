name: Android Build APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Grant execute permission
        run: chmod +x ./gradlew

      # üõ†Ô∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏õ
      - name: Customize Project
        run: |
          # 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ‡πÉ‡∏ô strings.xml
          if [ -f app_name.txt ]; then
            APP_NAME=$(cat app_name.txt)
            sed -i "s|<string name=\"app_name\">.*</string>|<string name=\"app_name\">$APP_NAME</string>|g" app/src/main/res/values/strings.xml
          fi
          
          # 2. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Package Name ‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Java
          if [ -f package.txt ]; then
            NEW_PKG=$(cat package.txt)
            OLD_PKG=$(grep "applicationId" app/build.gradle | sed 's/.*applicationId "\(.*\)".*/\1/')
            
            # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç build.gradle
            sed -i "s/applicationId \".*\"/applicationId \"$NEW_PKG\"/" app/build.gradle
            
            # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç AndroidManifest.xml
            sed -i "s/package=\".*\"/package=\"$NEW_PKG\"/" app/src/main/AndroidManifest.xml
            
            # ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå Java ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
            NEW_PATH=$(echo $NEW_PKG | tr '.' '/')
            mkdir -p app/src/main/java/$NEW_PATH
            # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå Java ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î package ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå
            find app/src/main/java -name "*.java" -exec sed -i "s/package .*;/package $NEW_PKG;/" {} +
            # ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà path ‡πÉ‡∏´‡∏°‡πà
            find app/src/main/java -name "*.java" -exec mv {} app/src/main/java/$NEW_PATH/ \;
          fi

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Publish APK to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Android Build ${{ github.run_number }}
          files: app/build/outputs/apk/release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
